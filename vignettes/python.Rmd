---
title: "The Phoenix Sepsis Criteria in Python"
output:
 rmarkdown::html_vignette:
   toc: true
   toc_depth: 2
   number_sections: false
bibliography: references.bib
vignette: >
 %\VignetteIndexEntry{The Phoenix Sepsis Criteria in Python}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---

```{r, eval = FALSE, include = FALSE}
################################################################################
#                                IMPORTANT NOTE                                #
#                                                                              #
#   This vignette _is not_ part of the R package, it is part of the website!   #
################################################################################
```

```{r, label = setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE)
library(reticulate)
library(phoenix)

if (!virtualenv_exists(envname = "phoenix")) {
  virtualenv_create(envname = "phoenix")
  virtualenv_install(envname = "phoenix", packages = c("numpy", "pandas"))
  virtualenv_install(envname = "phoenix", packages = normalizePath('python'))
}

use_virtualenv(virtualenv = "phoenix")

```

# Introduction

For those who are primarily working in python and want or need to implement the
Phoenix Sepsis criteria there are a couple options.

1. Use [rpy2](https://rpy2.github.io/index.html) to use the phoenix R package
   within python

2. Use the [python module](https://github.com/dewittpe/phoenix/tree/main/python).
   The rest of this article will focus on the use of this module


# Background
It would be helpful to read the first few sections of the [Get
started](https://cu-dbmi-peds.github.io/phoenix/articles/phoenix.html) article
for details on the Phoenix criteria

# Python Module

## Install

The python module can be installed via

```{python, eval = FALSE}
pip install pheonix-sepsis
```

## Importing the module

The needed modules to run the examples are:

```{python class.source="pychunk"}
import numpy as np
import pandas as pd
import importlib.resources
import phoenix as phx
```

## Example Data Set
The same example data provided in the R package has also been provided in the
python module.

```{python}
path = importlib.resources.files('phoenix')
sepsis = pd.read_csv(path.joinpath('data').joinpath('sepsis.csv'))
print(sepsis.head())
```

## Organ Dysfunction Scores

All eight organ dysfunction scoring functions return integer valued numpy
arrays.

### Respiratory
```{python}
py_resp = phx.phoenix_respiratory(
    pf_ratio = sepsis["pao2"] / sepsis["fio2"],
    sf_ratio = np.where(sepsis["spo2"] <= 97, sepsis["spo2"] / sepsis["fio2"], np.nan),
    imv      = sepsis["vent"],
    other_respiratory_support = (sepsis["fio2"] > 0.21).astype(int).to_numpy()
)
print(type(py_resp))
print(py_resp)
```

```{r include = FALSE}
r_resp <- phoenix_respiratory(
  pf_ratio = pao2 / fio2,
  sf_ratio = ifelse(spo2 <= 97, spo2 / fio2, NA_real_),
  imv = vent,
  other_respiratory_support = as.integer(fio2 > 0.21),
  data = sepsis
  )
stopifnot(identical(r_resp, as.integer(py$py_resp)))
```

### Cardiovascular

```{python}
py_card = phx.phoenix_cardiovascular(
    vasoactives = sepsis["dobutamine"] + sepsis["dopamine"] + sepsis["epinephrine"] + 
                  sepsis["milrinone"] + sepsis["norepinephrine"] + sepsis["vasopressin"],
    lactate = sepsis["lactate"],
    age = sepsis["age"],
    map = sepsis["dbp"] + (sepsis["sbp"] - sepsis["dbp"]) / 3
)
print(type(py_card))
print(py_card)
```

```{r include = FALSE}
r_card <- phoenix_cardiovascular(
  vasoactives = dobutamine + dopamine + epinephrine + milrinone + norepinephrine + vasopressin,
  lactate = lactate,
  age = age,
  map = dbp + (sbp - dbp)/3,
  data = sepsis
)
stopifnot(identical(r_card, as.integer(py$py_card)))
```

### Coagulation

```{python}
py_coag = phx.phoenix_coagulation(
    platelets = sepsis['platelets'],
    inr = sepsis['inr'],
    d_dimer = sepsis['d_dimer'],
    fibrinogen = sepsis['fibrinogen']
)
print(type(py_coag))
print(py_coag)
```

```{r, include = FALSE}
r_coag <- phoenix_coagulation(platelets, inr, d_dimer, fibrinogen, data = sepsis)
stopifnot(identical(r_coag, as.integer(py$py_coag)))
```

### Neurologic

```{python}
py_neur = phx.phoenix_neurologic(
    gcs = sepsis["gcs_total"],
    fixed_pupils = (sepsis["pupil"] == "both-fixed").astype(int)
)
print(type(py_neur))
print(py_neur)
```

```{r, include = FALSE}
r_neur <-
  phoenix_neurologic(
    gcs = gcs_total,
    fixed_pupils = as.integer(pupil == "both-fixed"),
    data = sepsis
  )
stopifnot(identical(r_neur, as.integer(py$py_neur)))
```

### Endocrine

```{python}
py_endo = phx.phoenix_endocrine(sepsis["glucose"])
print(type(py_endo))
print(py_endo)
```

```{r, include = FALSE}
r_endo <- phoenix_endocrine(glucose, data = sepsis)
stopifnot(identical(r_endo, as.integer(py$py_endo)))
```

### Immunologic

```{python}
py_immu = phx.phoenix_immunologic(sepsis["anc"], sepsis["alc"])
print(type(py_immu))
print(py_immu)
```

```{r, include = FALSE}
r_immu <- phoenix_immunologic(anc, alc, sepsis)
stopifnot(identical(r_immu, as.integer(py$py_immu)))
```

### Renal

```{python}
py_renal = phx.phoenix_renal(sepsis["creatinine"], sepsis["age"])
print(type(py_renal))
print(py_renal)
```

```{r, include = FALSE}
r_renal <- phoenix_renal(creatinine = creatinine, age = age, data = sepsis)
stopifnot(identical(r_renal, as.integer(py$py_renal)))
```

### Hepatic

```{python}
py_hepatic = phx.phoenix_hepatic(sepsis["bilirubin"], sepsis["alt"])
print(type(py_hepatic))
print(py_hepatic)
```

```{r, include = FALSE}
r_hepatic <- phoenix_hepatic(bilirubin = bilirubin, alt = alt, data = sepsis)
stopifnot(identical(r_hepatic, as.integer(py$py_hepatic)))
```


## Phoenix

```{python}
py_phoenix_scores = phx.phoenix(
    pf_ratio = sepsis["pao2"] / sepsis["fio2"],
    sf_ratio = np.where(sepsis["spo2"] <= 97, sepsis["spo2"] / sepsis["fio2"], np.nan),
    imv      = sepsis["vent"],
    other_respiratory_support = (sepsis["fio2"] > 0.21).astype(int).to_numpy(),
    vasoactives = sepsis["dobutamine"] + sepsis["dopamine"] + sepsis["epinephrine"] + sepsis["milrinone"] + sepsis["norepinephrine"] + sepsis["vasopressin"],
    lactate = sepsis["lactate"],
    age = sepsis["age"],
    map = sepsis["dbp"] + (sepsis["sbp"] - sepsis["dbp"]) / 3,
    platelets = sepsis['platelets'],
    inr = sepsis['inr'],
    d_dimer = sepsis['d_dimer'],
    fibrinogen = sepsis['fibrinogen'],
    gcs = sepsis["gcs_total"],
    fixed_pupils = (sepsis["pupil"] == "both-fixed").astype(int),
    )
```

```{r, include = FALSE}
r_phoenix_scores <-
  phoenix(
    # respiratory
      pf_ratio = pao2 / fio2,
      sf_ratio = ifelse(spo2 <= 97, spo2 / fio2, NA_real_),
      imv = vent,
      other_respiratory_support = as.integer(fio2 > 0.21),
    # cardiovascular
      vasoactives = dobutamine + dopamine + epinephrine + milrinone + norepinephrine + vasopressin,
      lactate = lactate,
      age = age,
      map = dbp + (sbp - dbp)/3,
    # coagulation
      platelets = platelets,
      inr = inr,
      d_dimer = d_dimer,
      fibrinogen = fibrinogen,
    # neurologic
      gcs = gcs_total,
      fixed_pupils = as.integer(pupil == "both-fixed"),
    data = sepsis
  )
stopifnot(
all.equal(r_phoenix_scores, as.data.frame(py$py_phoenix_scores),
          check.attributes = FALSE)
)
```

## Phoenix-8

```{python}
py_phoenix8_scores = phx.phoenix8(
    pf_ratio = sepsis["pao2"] / sepsis["fio2"],
    sf_ratio = np.where(sepsis["spo2"] <= 97, sepsis["spo2"] / sepsis["fio2"], np.nan),
    imv      = sepsis["vent"],
    other_respiratory_support = (sepsis["fio2"] > 0.21).astype(int).to_numpy(),
    vasoactives = sepsis["dobutamine"] + sepsis["dopamine"] + sepsis["epinephrine"] + sepsis["milrinone"] + sepsis["norepinephrine"] + sepsis["vasopressin"],
    lactate = sepsis["lactate"],
    map = sepsis["dbp"] + (sepsis["sbp"] - sepsis["dbp"]) / 3,
    platelets = sepsis['platelets'],
    inr = sepsis['inr'],
    d_dimer = sepsis['d_dimer'],
    fibrinogen = sepsis['fibrinogen'],
    gcs = sepsis["gcs_total"],
    fixed_pupils = (sepsis["pupil"] == "both-fixed").astype(int),
    glucose = sepsis["glucose"],
    anc = sepsis["anc"],
    alc = sepsis["alc"],
    creatinine = sepsis["creatinine"],
    bilirubin = sepsis["bilirubin"],
    alt = sepsis["alt"],
    age = sepsis["age"]
    )
```

```{r, include = FALSE}
r_phoenix8_scores <-
  phoenix8(
    # respiratory
      pf_ratio = pao2 / fio2,
      sf_ratio = ifelse(spo2 <= 97, spo2 / fio2, NA_real_),
      imv = vent,
      other_respiratory_support = as.integer(fio2 > 0.21),
    # cardiovascular
      vasoactives = dobutamine + dopamine + epinephrine + milrinone + norepinephrine + vasopressin,
      lactate = lactate,
      age = age, # Also used in the renal assessment.
      map = dbp + (sbp - dbp)/3,
    # coagulation
      platelets = platelets,
      inr = inr,
      d_dimer = d_dimer,
      fibrinogen = fibrinogen,
    # neurologic
      gcs = gcs_total,
      fixed_pupils = as.integer(pupil == "both-fixed"),
    # endocrine
      glucose = glucose,
    # immunologic
      anc = anc,
      alc = alc,
    # renal
      creatinine = creatinine,
      # no need to specify age again
    # hepatic
      bilirubin = bilirubin,
      alt = alt,
    data = sepsis
  )
stopifnot(
  all.equal(r_phoenix8_scores, as.data.frame(py$py_phoenix8_scores),
            check.attributes = FALSE)
)
```

